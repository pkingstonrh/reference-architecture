---
- name: Create tfstate backend
  hosts: localhost
  connection: local
  gather_facts: false
  tasks:
    - name: Pull tf file
      ansible.builtin.git:
        repo: "{{ git_repo }}"
        dest: /tf
      become: true
    - name: Inject template vars for create-remote-storage.tf
      ansible.builtin.template:
        src: /tf/{{ path_to_tf_state }}/create-remote-storage.tf.j2
        dest: /tf/{{ path_to_tf_state }}/create-remote-storage.tf
      become: true
    - name: Initialize Terraform Provider for tfstate
      community.general.terraform:
        project_path: /tf/{{ path_to_tf_state }}
        state: absent
        force_init: true
    - name: Deploy terraform instance for tfstate
      community.general.terraform:
        project_path: /tf/{{ path_to_tf_state }}
        state: present
      register: deployed_tf_state
